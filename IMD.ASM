; File: IMD.ASM (From NZY.ASM)02; 92,9-96,4. By: Jian Jing; Allright reserved.; ==================================================================; 装载扩展词汇文件 ACZY.DAT 到XMS或者放于硬盘，然后登记 INT 66h; 整个输入法仅占用3K内存空间, 且编码库突破 64K 限制.; 94.12.3 完成一个模块安装管理10种自由输入法的集成功能.model tiny.code.286p                org     100hstart:                jmp     begin; 每个编码库需要的结构, 每个结构占 59-12 bytes, 共有10个结构; -------------------------------------------------------filename        db      'DRV\'fichg           db      'SP      .IMD',0max_seg         dw      0max_off         dw      0EMB_count       dd      0EMB_Sr_hand     dw      0EMB_Sr_offset   dd      0EMB_Dr_hand     dw      0EMB_Dr_offset   dd      0in_if_09        db      0               ; 是否允许数字编码in_zymi         db      0               ; 最大码长in_name         db      8       dup(0)  ; 输入法名称; -------------------------------------------------------i1_beg          db      'DRV\IMDY1   .IMD',0                dw      0                dw      0                dd      0                dw      0                dd      0                dw      0                dd      0                db      0                db      0                db      8       dup(0); -----------------------------                db      'DRV\IMDY2   .IMD',0                dw      0                dw      0                dd      0                dw      0                dd      0                dw      0                dd      0                db      0                db      0                db      8       dup(0); -----------------------------                db      'DRV\IMDY3   .IMD',0                dw      0                dw      0                dd      0                dw      0                dd      0                dw      0                dd      0                db      0                db      0                db      8       dup(0); -----------------------------                db      'DRV\IMDY4   .IMD',0                dw      0                dw      0                dd      0                dw      0                dd      0                dw      0                dd      0                db      0                db      0                db      8       dup(0); -----------------------------                db      'DRV\IMDY5   .IMD',0                dw      0                dw      0                dd      0                dw      0                dd      0                dw      0                dd      0                db      0                db      0                db      8       dup(0); -----------------------------                db      'DRV\IMDY6   .IMD',0                dw      0                dw      0                dd      0                dw      0                dd      0                dw      0                dd      0                db      0                db      0                db      8       dup(0); -----------------------------                db      'DRV\IMDY7   .IMD',0                dw      0                dw      0                dd      0                dw      0                dd      0                dw      0                dd      0                db      0                db      0                db      8       dup(0); -----------------------------                db      'DRV\IMDY8   .IMD',0                dw      0                dw      0                dd      0                dw      0                dd      0                dw      0                dd      0                db      0                db      0                db      8       dup(0); -----------------------------                db      'DRV\IMDY9   .IMD',0                dw      0                dw      0                dd      0                dw      0                dd      0                dw      0                dd      0                db      0                db      0                db      8       dup(0); -----------------------------                db      'DRV\IMDY0   .IMD',0                dw      0                dw      0                dd      0                dw      0                dd      0                dw      0                dd      0                db      0                db      0                db      8       dup(0); -----------------------------XMS_Entry       dd      0xmsumb          dw      0file_hand       dw      0dgdy            db      0dis_begin_82    dw      0di_begin_82     dw      0dis_begin_81    dw      0di_begin_81     dw      0dis_begin       dw      0di_begin        dw      0dis_continue    dw      0di_continue     dw      0di_this         dw      0es_this         dw      0fun_aczy        db      0; -----------------------------di_offset       dw      offset cz_buf           ;0cl_begin_82     db      0si_begin_82     dw      0si_buf          dw      0di_buf          dw      0mblg            db      0       ; 输入码长度tuzm_add        dw      0just_tuzm       db      "~"int65h          dd      0int66h          dd      0       ; 前翻页时递归调用all_leng        db      24      ; 一次可转换词汇总长度(联想时为50)pre_al          db      0; 下面三个变量位置不应改动; -------------------------------if_09           db      0               ; 是否允许数字编码zymi            db      0               ; 最大码长input_name      db      '　　　　'      ; 自定义输入法名; -------------------------------; 进入:;       AH=0自动记忆,7fh释放,80h从头找,81h后翻页,82h前翻页,83h从当前页找;       AL    = 输入法号(0-9);       DS:SI = 双拼编码所在地址;       DS:DI = 词汇转移地址;       CL    = 词汇编码长度;             = 80h , 代表查找联想字词(在 SI 中);       DS:BP = "?" 所在位置替代的字符(顺序排放); 返回:;       CL = 词汇长度 (包括重码), 若 CL = 0 则代表无此编码词汇;       DL = 重码个数 (全部放在DS:SI); -------------------------------int66:                cld                mov     cs:fun_aczy,ah                or      ah,ah                   ; AH=0, 自动记忆调用                jnz     short n_self_word                mov     byte ptr cs:i66c65,1                pushf                call    cs:int65h                mov     byte ptr cs:i66c65,0                iretn_self_word:                cmp     ah,7Fh                  ; 7Fh 功能, 释放自己                jnz     short not_free                cmp     al,1                ja      short nfrall    ; 非全体释放, 转fr_nxal:                call    fr_al                inc     al                cmp     al,10d                jbe     short fr_nxal                mov     dx,cs:xmsumb                or      dx,dx                jz      short dos_umb                mov     ah,11h                call    cs:XMS_Entry                jmp     short okfreeumbdos_umb:                push    cs                pop     es                mov     ah,49h                int     21h             ; 释放自身内存空间okfreeumb:                xor     dx,dx                mov     ds,dx                mov     ax,8365h        ; 65 取消登记屏幕取词功能                int     16h                iretnfrall:                call    fr_al                iret; 释放AL号输入法(AL=1-10); -----------------------fr_al:                push    ax                push    bx                push    dx                xor     ah,ah                mov     bx,59d-12d                mul     bx                add     ax,offset filename                mov     bx,ax                mov     word ptr cs:[bx],0                mov     dx,cs:[bx+37d-12d]          ;30d] ;EMB_Sr_hand                or      dx,dx                jz      short nf_xms                mov     word ptr cs:[bx+37d-12d],0  ;30d],0                mov     ah,5                call    cs:XMS_Entry                mov     ah,0ah                call    cs:XMS_Entrynf_xms:                pop     dx                pop     bx                pop     ax                retnnot_free:                cmp     byte ptr cs:dgdy,0                jnz     short nopen             ;not_move                cmp     al,cs:pre_al                jz      short not_move          ;AL=当前输入法,不再搬移参数                call    mov_pre_al                mov     cs:pre_al,alnot_move:                cmp     word ptr cs:EMB_Sr_hand,0                jnz     short nopen                push    ds                push    ax                push    dx                push    cs                pop     ds                mov     dx,offset filename                mov     ax,95fch                int     10h                mov     ax,3D00h                int     21h                mov     cs:file_hand,ax                pop     dx                pop     ax                pop     dsnopen:                push    es                push    di                      ; 保存转移地址                mov     cs:source_di,di                mov     cs:mblg,cl              ; 编码长度                mov     byte ptr cs:all_leng,24 ; 查编码字词时长度30                cmp     byte ptr cs:mblg,80h                jnz     short upok                mov     byte ptr cs:all_leng,50 ; 查联想字词时长度50upok:                xor     cx,cx                xor     dl,dl                xor     di,di                mov     es,di                mov     cs:si_buf,si                mov     cs:tuzm_add,bp                mov     word ptr cs:cx_max,0                cmp     ah,82h                  ; AH=82H 前翻页                jz      short is82_fun                jmp     if_follis82_fun:                push    di                mov     di,es                cmp     di,cs:dis_begin                pop     di                jnz     short nequ_es                cmp     di,cs:di_begin                jnz     short nequ_es                jmp     cp_nxt_1        ; 比较上一回起始指针,已在库首,转一切从头nequ_es:                mov     di,cs:dis_begin                mov     cs:dis_begin_82,di      ; 保存上次起始地址                mov     di,cs:di_begin                mov     cs:di_begin_82,di                mov     cl,cs:mblg                mov     cs:cl_begin_82,cl                mov     cs:si_begin_82,si                pop     di                push    di                mov     ah,80h                  ; 首先从头查找                mov     byte ptr cs:dgdy,1                pushf                call    cs:int66h               ; 递归调用                mov     byte ptr cs:dgdy,0if_vdok:                mov     cl,cs:cl_begin_82                mov     si,cs:si_begin_82                mov     ax,cs:dis_continue                cmp     ax,cs:dis_begin_82                jnz     short nequ_es1                mov     ax,cs:di_continue                cmp     ax,cs:di_begin_82       ; 上次结束处是否本次开始处?                jz      short vdok              ; 是,上页开始在 di_beginnequ_es1:                pop     di                push    di                mov     ah,81h                  ; 否则,后翻页继续查找                mov     byte ptr cs:dgdy,1                pushf                call    cs:int66h               ; 递归调用                mov     byte ptr cs:dgdy,0                jmp     short if_vdokvdok:                mov     es,cs:dis_begin                mov     di,cs:di_begin                xor     cx,cx                   ; 初始化记数变量                xor     dl,dl                jmp     short cp_nxt_1if_foll:                cmp     ah,81h                  ; AH=81H 后翻页,继续查找                jnz     short ifcure_p          ; 从上次结束处开始                mov     es,cs:dis_continue                mov     di,cs:di_continue                jmp     short cp_nxt_1ifcure_p:                cmp     ah,83h                  ; AH=83H 从当前页开始查找                jnz     short cp_nxt_1                mov     es,cs:es_this                mov     di,cs:di_thiscp_nxt_1:                mov     si,cs:dis_begin                mov     cs:dis_begin_81,si                mov     si,cs:di_begin                mov     cs:di_begin_81,si       ; 先保存起始指针,以便在未找到编码字词时恢复                mov     cs:dis_begin,es                mov     cs:di_begin,di          ; 记录当前起始指针                call    move_to_esdicp_nxt:                mov     word ptr cs:mov_todi,0                mov     si,cs:si_buf                mov     bx,cs:di_offset                mov     al,cs:[bx]              ; +offset cz_buf]                cmp     al,'$'                jnz     short cpbegin                cmp     byte ptr cs:mblg,81h                jnz     short nrpdies                mov     cx,cs:cx_max                mov     di,cs:dis_begin_81                mov     cs:dis_begin,di                mov     di,cs:di_begin_81                mov     cs:di_begin,di  ; 恢复原来起始指针                jmp     pdiesnrpdies:                jmp     cppw_ok                 ; 整个词库搜索结束,转cpbegin:                xor     bx,bx                   ; 初始比较偏移长度                cmp     byte ptr cs:mblg,80h    ; 查联想字词                jae     ishz_to                jmp     chokokishz_to:                mov     bx,cs:di_offset                mov     al,cs:[bx]                cmp     al,0A0h                ja      short islxhz    ; 搜索到第一个汉字开始                cmp     byte ptr cs:mblg,81h                jnz     short dincnx    ; 非查找输入码                mov     bx,offset my_bm ; cs:source_di                add     bx,cs:mov_todi                mov     cs:[bx],al                inc     word ptr cs:mov_todidincnx:                call    di_inc                jmp     short ishz_toislxhz:                mov     ax,word ptr cs:[bx]     ; +offset cz_buf]                add     bx,2                cmp     si,ax                jz      short xdvcnbmok:                jmp     cnok            ; 非联想字, 转xdvc:                mov     ah,cs:[bx]      ; +offset cz_buf]                cmp     byte ptr cs:mblg,81h                jnz     short jbea0                cmp     ah,0a0h                ja      short nbmok     ; 非单字,不是编码ishvbm:                mov     cx,cs:mov_todi  ; CX=编码长度                cmp     cx,cs:cx_max                jb      short nbmok                mov     cs:cx_max,cx                push    si                mov     si,offset my_bm                mov     bx,cs:source_dinxmytoy:                mov     al,cs:[si]                mov     ds:[bx],al                inc     si                inc     bx                loop    nxmytoy                pop     si                jmp     short nbmokjbea0:                cmp     ah,0a0h                jbe     short cnok              ; 单汉字编码,无联想字词                sub     bx,2                sub     bx,cs:di_offset                jmp     cppw_eq         ; 否则联想字词找到,转; -------------chokok:                cmp     al,'\'                jnz     short cp10n                mov     ah,al                call    get_tuzm        ; 转提示编码                mov     bx,1                jmp     cppw_eqcp10n:                mov     al,ds:[si+bx]                add     bx,cs:di_offset                mov     ah,cs:[bx]      ; +offset cz_buf]                cmp     ah,0a0h                ja      short cnok      ; 若非编码(为汉字),转不匹配处理                cmp     al,'?'          ; '/'                jz      short mhdz      ; 模糊单字母,直接相等                cmp     al,'*'          ; '?'                jz      short x_d_x     ; 以后字母模糊 "*.*"                and     ax,5f5fh        ; 转为小写字母比较                cmp     al,ah                jnz     short cnokmhdz:                sub     bx,cs:di_offset                inc     bx                cmp     bl,cs:mblg                jae     short si_over                cmp     byte ptr ds:[si+bx],'*' ;'?'                jnz     short cp10n     ; 下个字符是'?',模糊确定                add     bx,cs:di_offset                mov     ah,cs:[bx]      ; +offset cz_buf]                dec     bx              ; jmp     short xdx1x_d_x:                call    get_tuzm        ; 转提示编码x_d_xx:                inc     bx              ; BX 长度加到下个词汇开始                cmp     byte ptr cs:[bx],0A1h   ;+offset cz_buf],0A1h                jb      short x_d_xx                sub     bx,cs:di_offset                jmp     short cppw_eqcnok:cnok_ct:                call    di_inc          ; 编码不匹配,继续找下一个                mov     bx,cs:di_offset                cmp     byte ptr cs:[bx],0A1h   ; +offset cz_buf],0A1h                jb      short cnok_ctcnok_nx:                call    di_inc                mov     bx,cs:di_offset                mov     al,cs:[bx]              ; +offset cz_buf]                cmp     al,0a0h                ja      short cnok_nx                cmp     byte ptr cs:mblg,80h    ; 查联想字词,重码不跳过                jz      short jcp_nxt                cmp     al,'\'                  ; 查编码字词,跳过重码                jnz     short jcp_nxt                cmp     byte ptr cs:mblg,81h    ; 查联想字词,重码不跳过                jnz     short cnok_nx                cmp     byte ptr cs:[bx+3],0A0h                ja      short cnok_nx                mov     ax,cs:[bx+1]                cmp     si,ax                jnz     short cnok_nx                jmp     ishvbmjcp_nxt:                jmp     cp_nxt; ------------------------------------------------------------si_over:                add     bx,cs:di_offset                cmp     byte ptr cs:[bx],0A1h   ; +offset cz_buf],0A1h                jb      short cnok      ; 词汇库中的词汇编码长度是否比较完毕                sub     bx,cs:di_offset ; 没有,编码不匹配cppw_eq:                or      dl,dl                jnz     short no_first                cmp     byte ptr cs:mblg,80h                jz      short no_first  ; 联想方式, 不记录                cmp     byte ptr cs:fun_aczy,80h                jz      short y_first                cmp     byte ptr cs:fun_aczy,83h                jnz     short no_firsty_first:                mov     cs:di_this,di                mov     cs:es_this,es   ;当前页第一词位置                mov     word ptr cs:dis_begin,0                mov     word ptr cs:di_begin,0                mov     word ptr cs:dis_begin_81,0                mov     word ptr cs:di_begin_81,0no_first:                inc     dl              ; 匹配词汇加一                call    di_addbx                mov     si,di           ; 编码匹配, SI 指向词汇                pop     di                and     word ptr ds:[di-2],7f7fh        ; 前个重码尾部汉字cp_eq1:                mov     bx,cs:di_offset                mov     al,cs:[bx]              ; +offset cz_buf]                cmp     byte ptr cs:mblg,80h    ; 查联想字词                jz      short ce_1                cmp     al,'\'                jnz     short ce_1                mov     ah,al                call    get_tuzm                cmp     byte ptr cs:[bx+1],0A1h ; +(offset cz_buf+1)],0A1h                jb      short noidl                cmp     cl,cs:all_leng                jae     short cppw_ok2                cmp     dl,9                ja      short cppw_ok2                inc     dl                        ; 重码个数加 1noidl:                and     word ptr ds:[di-2],7f7fh  ; 前个重码尾部汉字屏蔽掉高位                jmp     short ce_2ce_1:                cmp     al,0a0h                jbe     short cppw_ok2                mov     ds:[di],al      ; 词汇转移进 DS:DI                inc     cl              ; 长度加 1                inc     dice_2:                call    si_inc                jmp     short cp_eq1; ----------------------------------------------------------------rep_di          dw      0rep_leng        db      0source_di       dw      0mov_todi        dw      0cx_max          dw      0my_bm           db      12d     dup(0)cppw_ok2:                and     word ptr ds:[di-2],7f7fh                cmp     byte ptr cs:mblg,80h    ; 查联想字词                jnz     short cppw_ok_1; ----------------------; 取消重复联想字词子程序                pusha                push    ds                push    es                push    ds                pop     es                mov     si,di                sub     si,2nssi2:                sub     si,2                cmp     si,cs:source_di                jbe     short okcim                mov     ax,ds:[si]                test    ax,8080h                jnz     short nssi2                add     si,2                mov     cs:rep_di,si    ; 本联想字词开始地址                mov     cx,di                sub     cx,si                mov     cs:rep_leng,cl  ; 本联想字词长度                mov     di,cs:source_dicpniml:                push    cx                push    di                push    si                rep     cmpsb                pop     si                pop     di                pop     cx                jz      short ok_subim  ; 前面已有,转取消本字词addi2ok:                add     di,2                mov     ax,ds:[di]                test    ax,8080h                jnz     short addi2ok                add     di,2                cmp     di,si                jae     short okcim                jmp     short cpnimlok_subim:                pop     es                pop     ds                popa                mov     di,cs:rep_di                sub     cl,cs:rep_leng                dec     dl                jmp     short cppw_ok_1okcim:                pop     es                pop     ds                popa; ----------------------cppw_ok_1:                push    di                mov     cs:di_buf,di    ; 保存当前的 DS:DI 指针                mov     di,si           ; DI = SI (词汇库当前指针)                cmp     cl,cs:all_leng                jae     short cppw_ok   ; 词汇总长度超过30,返回                cmp     dl,9                ja      short cppw_ok                jmp     cp_nxt          ; 找下一个相同的编码; ----------------------------------------------------------------------cppw_ok:                mov     cs:dis_continue,es                mov     cs:di_continue,di       ; 保存当前词汇库指针                cmp     dl,1                jae     short cppw_ok_2 ; 无重码, 直接返回                mov     di,cs:dis_begin_81                mov     cs:dis_begin,di                mov     di,cs:di_begin_81                mov     cs:di_begin,di  ; 无码返回, 恢复原来起始指针cppw_ok_2:                xor     al,al                mov     bx,cs:dis_begin                or      bx,bx                jnz     short pdies                mov     bx,cs:di_begin                or      bx,bx                jnz     short pdies                mov     al,1                    ; 当前在第一页,AL=1,否则AL=0pdies:                pop     di                pop     es                cmp     word ptr cs:EMB_Sr_hand,0                jnz     short nclose                cmp     byte ptr cs:dgdy,0                jnz     short nclose                push    ax                mov     bx,cs:file_hand                mov     ah,3eh                int     21h                pop     axnclose:                iret; --------------------------get_tuzm:                push    si                push    dx                mov     si,cs:tuzm_add                xor     dh,dh                add     si,dx                cmp     ah,0a0h                jbe     short vjt                mov     ah,"~"                jmp     short vjt2vjt:                cmp     ah,'\'                jnz     short vjt1                mov     ah,byte ptr cs:just_tuzm                jmp     short vjt2vjt1:                and     ah,5fh                add     ah,20h                  ; 转为小写字母vjt2:                mov     byte ptr ds:[si],ah     ; 填写替代码                mov     byte ptr cs:just_tuzm,ah                pop     dx                pop     si                retn; 移动词库指针到指定的搜索32位指针处(ES:DI); -----------------------------------------move_to_esdi:                push    ds                pusha                push    cs                pop     ds                mov     dx,di                mov     cx,es                add     dx,12d          ; 词库文件头长度 12 Bytes                adc     cx,0                mov     cure_cx,cx                mov     cure_dx,dx                cmp     word ptr EMB_Sr_hand,0                jz      short isfile; 从 XMS 中读出词库当前指针处的内容                mov     word ptr EMB_Sr_offset,dx                mov     word ptr EMB_Sr_offset+2,cx                mov     word ptr EMB_count,1024d*1d                cmp     cx,max_seg                jb      short ms_cont                mov     cx,max_off                sub     cx,dx                test    cx,1                jz      short cxeuu                inc     cxcxeuu:                cmp     cx,1024d*1d                jae     short ms_cont                mov     word ptr EMB_count,cxms_cont:                mov     si,offset EMB_count                mov     ah,0Bh                call    cs:XMS_Entry                or      ax,ax                jnz     short okax                sub     word ptr EMB_count,2                jmp     short ms_contokax:                mov     ax,word ptr EMB_count                jmp     short move_endisfile:                mov     bx,file_hand                mov     ax,4200h                int     21h             ; 移动指针 -> ES:DI                mov     ah,3fh                mov     bx,file_hand                mov     cx,1024d*1d                mov     dx,offset cz_buf                int     21hmove_end:                mov     word ptr di_offset,offset cz_buf        ;0; 初始缓冲区记数为0                popa                pop     ds                retnsi_inc:                inc     si                jnz     short nises                push    si                mov     si,es                inc     si                mov     es,si                pop     sinises:                inc     word ptr cs:di_offset                cmp     word ptr cs:di_offset,offset cz_buf+1024d*1d-20d                jb      short diinc_ret                push    di                mov     di,si                call    move_to_esdi                pop     di                retndi_inc:                inc     di                jnz     short nies                push    di                mov     di,es                inc     di                mov     es,di                pop     dinies:                inc     word ptr cs:di_offsetcmpczof:                cmp     word ptr cs:di_offset,offset cz_buf+1024d*1d-20d                jb      short diinc_ret                call    move_to_esdidiinc_ret:                retndi_addbx:                add     di,bx                jnc     short naes                push    di                mov     di,es                inc     di                mov     es,di                pop     dinaes:                add     word ptr cs:di_offset,bx                jmp     short cmpczoflodsw_hz:                lodsw                cmp     byte ptr cs:i66c65,0                jz      short lbsw                sub     cl,2                retnlbsw:                xor     ah,ah                dec     cl                jz      short cl0ret                cmp     al,0A0h                jbe     short lodsw_hz                mov     ah,ds:[si]                inc     si                inc     si                dec     cl                jz      short cl0ret                cmp     ah,0A0h                jbe     short lodsw_hzcl0ret:                retn; 取汉字编码子程序(AX=汉字内码,DS:DI=编码转移地址)get_cbm:                push    cx                push    ds                push    si                push    cs                pop     ds                mov     si,ax           ; SI=汉字码                mov     cl,81h          ; CL=81h                mov     ah,80h          ; AH=80h                mov     al,cs:pre_al    ; AL=当前输入法号                push    di                push    bx                pushf                call    cs:int66h                pop     bx                pop     di                pop     si                pop     ds                add     di,cx                mov     byte ptr cs:[di],0      ; 无编码,置为0                sub     di,cxnz00:                pop     cx                retnnxf1c:                or      cl,cl                jz      short endf1c                mov     al,cs:[si]                or      al,al                jz      short endf1c                mov     ds:[bx],al                inc     bx                inc     si                dec     cl                jmp     short nxf1cendf1c:                retncbm1            db      13d     dup(0)cbm2            db      13d     dup(0)cbm3            db      13d     dup(0)cbm4            db      13d     dup(0)di_tmp          dw      0i66c65          db      0;---------------------; AH=0取词,=1返回当前输入法号->AL,输入法名称->DS:SI; DS:SI = 词汇屏幕地址; DS:BX = 词汇编码地址; CL = 词汇长度; CH = 词汇编码长度(CH=0时,返回自动编码);---------------------int65:                cld                or      ah,ah                jz      short isqcok                mov     al,cs:pre_al                push    cs                pop     ds                mov     si,offset in_name                iretisqcok:                pusha                push    es                push    ds                or      ch,ch                jz      short isself_bm                jmp     nselfbm   ; CH>0, 表示有自定义编码; 自动编码+(')isself_bm:                push    cx                push    si                push    bx                mov     byte ptr cs:cbm1[0],0                mov     byte ptr cs:cbm2[0],0                mov     byte ptr cs:cbm3[0],0                mov     byte ptr cs:cbm4[0],0                mov     ch,cl           ; CH=CL                call    lodsw_hz                mov     di,offset cbm1  ; 首汉字                call    get_cbm                or      cl,cl                jz      short end_offhzbm                call    lodsw_hz                mov     di,offset cbm2  ; 第二个汉字                call    get_cbm                or      cl,cl                jz      short end_offhzbm                call    lodsw_hz                mov     di,offset cbm3  ; 第三个汉字                call    get_cbm                or      cl,cl                jz      short end_offhzbmclnhz:                call    lodsw_hz                or      cl,cl                jnz     short clnhz                mov     di,offset cbm4  ; 末汉字                call    get_cbmend_offhzbm:                cmp     ch,8                jae     short is_mode1  ; 多字词，转                cmp     ch,4                jz      short is2zc     ; 2字词                cmp     ch,2                ja      short n1zc                mov     si,offset cbm1                mov     cl,10d                call    nxf1c           ; 单汉字                jmp     endschis_mode1:                mov     si,offset cbm1  ; 多字词                mov     cl,1                call    nxf1c                mov     si,offset cbm2                mov     cl,1                call    nxf1c                mov     si,offset cbm3                mov     cl,1                call    nxf1c                mov     si,offset cbm4                mov     cl,1                call    nxf1c                jmp     endschis2zc:                cmp     byte ptr cs:in_zymi,4                jbe     short mizd4                mov     cl,10d          ; 码长超出4码的,2字词取全码                mov     si,offset cbm1                call    nxf1c                mov     si,offset cbm2                call    nxf1c                jmp     endschmizd4:                mov     si,offset cbm1                mov     cl,2            ; 2字词                call    nxf1c                mov     si,offset cbm2                mov     cl,2                call    nxf1c                jmp     short endschn1zc:                cmp     byte ptr cs:in_zymi,4                jbe     short mizd4_3z                mov     si,offset cbm1  ; 最大码长超出4码的,3字词各取首码                mov     cl,1                call    nxf1c                mov     si,offset cbm2                mov     cl,1                call    nxf1c                mov     si,offset cbm3                mov     cl,1                call    nxf1c                jmp     short endschmizd4_3z:                test    byte ptr cs:in_if_09,20h                jnz     short is3zc     ; 3字词，首字头两码，转                mov     si,offset cbm1  ; 否则，末字头两码                mov     cl,1                call    nxf1c                mov     si,offset cbm2                mov     cl,1                call    nxf1c                mov     si,offset cbm3                mov     cl,2                call    nxf1c                jmp     short endschis3zc:                mov     si,offset cbm1                mov     cl,2                call    nxf1c                mov     si,offset cbm2                mov     cl,1                call    nxf1c                mov     si,offset cbm3                mov     cl,1                call    nxf1c;                jmp     short endschendsch:                pop     ax                sub     bx,ax                cmp     bl,cs:in_zymi                jbe     short okizi                mov     bl,cs:in_zymiokizi:                xchg    ax,bx                pop     si                pop     cx                mov     ch,al                mov     cs:di_tmp,cx                cmp     byte ptr cs:i66c65,0                ja      short nselfbm           ; 自动记忆，转存盘chl0r:                pop     ds                pop     es                popa                mov     cx,cs:di_tmp                iret; 转移词汇nselfbm:                or      ch,ch                   ; 编码长度0,直接返回                jz      short chl0r                push    ds                push    bx                push    cx                push    si                push    cs                pop     ds                push    cs                pop     es                mov     al,pre_al                call    mov_pre_al      ; 搬移当前输入法参数                mov     dx,offset filename                mov     ax,95fch                int     10h                mov     ax,3D02h                int     21h             ; 以读写模式打开词库文件                push    cs                pop     ds                mov     file_hand,ax                mov     cx,max_seg                mov     di,max_off                or      cx,cx                jnz     short oksbb                cmp     di,512d                jae     short oksbb                cmp     di,128d                jae     short oksbb127                xor     di,di                jmp     short okscxdioksbb127:                sub     di,128d                jmp     short okscxdioksbb:                sub     di,512d                sbb     cx,0okscxdi:                mov     es,cx                call    move_to_esdi    ; 读出词库尾部-512字节的内容                push    es                push    ax                mov     cx,1024d*1d                mov     al,'$'                push    cs                pop     es                mov     di,offset cz_buf                repnz   scasb                pop     ax                jnz     short isthax                sub     di,offset cz_buf                mov     ax,diisthax:                pop     es                mov     cx,cure_cx                mov     dx,cure_dx                add     dx,ax                adc     cx,0                mov     cure_cx_b,cx                mov     cure_dx_b,dx                mov     di,cure_dx_b                sub     di,cure_dx                add     di,offset cz_buf  ; 得指向"$"符的尾部指针 -> DI                dec     di                mov     di_tmp,di                pop     si                pop     cx                pop     bx                pop     ds                push    cs                pop     esrmcnbm:                mov     al,ds:[bx]                cmp     al,'a'                jb      short na5f              ; 小写字母, 转为大写字母                cmp     al,'z'                ja      short na5f                and     al,0DFhna5f:                stosb                           ; 填编码                inc     bx                dec     ch                jnz     short rmcnbm                xor     ah,ahrmnch:                lodsb                cmp     al,0a1h                jb      short nomt                stosb                           ; 转词汇进缓冲区                inc     ahnomt:                cmp     byte ptr cs:i66c65,0                ja      short lplbsw                inc     silplbsw:                loop    rmnch                shr     ah,1                jnc     short allrig                dec     diallrig:                mov     byte ptr es:[di],'$'    ; 词库结尾符                push    di                inc     di                sub     di,offset cz_buf        ; 新的长度                push    di                push    cs                pop     ds                mov     ax,EMB_Sr_hand                or      ax,ax                jz      short n_toXMS                mov     EMB_Dr_hand,ax  ; 转移到XMS空间                test    di,1                jz      short iseuu                inc     diiseuu:                mov     word ptr EMB_count,di                mov     word ptr EMB_Sr_hand,0                mov     word ptr EMB_Sr_offset,offset cz_buf                mov     word ptr EMB_Sr_offset+2,cs                mov     ax,cure_dx                mov     word ptr EMB_Dr_offset,ax                mov     ax,cure_cx                mov     word ptr EMB_Dr_offset+2,ax                mov     si,offset EMB_count                mov     ah,0Bh                call    cs:XMS_Entry                mov     ax,EMB_Dr_hand                mov     EMB_Sr_hand,ax                mov     word ptr EMB_Dr_hand,0                mov     word ptr EMB_Dr_offset,offset cz_buf                mov     word ptr EMB_Dr_offset+2,csn_toXMS:                mov     cx,cure_cx                mov     dx,cure_dx                mov     bx,file_hand                mov     ax,4200h                int     21h             ; 移动指针 -> CX;DX                pop     cx                mov     bx,file_hand                mov     dx,offset cz_buf                mov     ah,40h                int     21h             ; 写入新的词汇内容                mov     ah,3eh                int     21h                pop     cx                sub     cx,di_tmp                add     word ptr max_off,cx                adc     word ptr max_seg,0      ; 修改最大长度                mov     si,offset filename                mov     cx,59d-12d                mov     di,si                mov     al,pre_al                xor     ah,ah                inc     al                mul     cx                add     di,ax                repz    movsb           ; 搬回该输入法改动后的参数                pop     ds                pop     es                popa                iret; 将AL指定的输入法参数搬移到当前位置; -----------------------------------mov_pre_al:                push    ds                push    es                push    ax                push    cx                push    si                push    di                push    cs                pop     ds                push    cs                pop     es                mov     di,offset filename                xor     ah,ah                inc     al                mov     cx,59d-12d                mul     cx                add     ax,di                mov     si,ax                repz    movsb           ; 搬移该输入法参数                pop     di                pop     si                pop     cx                pop     ax                pop     es                pop     ds                retn; ================================================================cure_cx         dw      0ffffhcure_dx         dw      0ffffhcure_cx_b       dw      0ffffhcure_dx_b       dw      0ffffhal_buf          db      0ah_buf          db      0cz_buf          db      1024d*1d       dup(0); ================================================================umb_rest:                call    Self_LoadHi                cld                push    cs                pop     ds                push    cs                pop     es                mov     word ptr EMB_Dr_offset+2,cs                mov     si,offset filename                mov     di,offset filename+59d-12d                mov     cx,59d-12d                repz    movsb           ; 搬回第一种输入法改动后的参数                mov     dx,offset int66                mov     word ptr int66h,dx                mov     word ptr int66h+2,cs                mov     ax,8366h                mov     bh,1            ; 自动搜索;                mov     bl,yddj;                or      bl,bl;                jz      short notyd;                dec     bl;                mov     bh,3            ; 预定;notyd:                int     16h             ; 登记 66H 中断                mov     dx,offset int65                mov     word ptr int65h,dx                mov     word ptr int65h+2,cs                mov     ax,8365h                int     16h             ; 登记 65H 中断(屏幕取词)                mov     dx,offset umb_rest                int     27h                include aczy_umb.incload_mb:                mov     ax,4202h                mov     bx,file_hand                xor     cx,cx                xor     dx,dx                int     21h             ; 得到词库大小 -> DX:AX                mov     max_seg,dx                mov     max_off,ax                call    test_xms                jz      short okxmsjnxms:                jmp     noxmsokxms:                call    get_xms_ent                mov     ax,max_off                mov     dx,max_seg                add     ax,1023d                adc     dx,0                mov     cx,1024d                div     cx                mov     dx,ax           ; 词库 KB 数 -> DX                add     dx,5            ; 加上5K屏幕取词空间na5k:                mov     ah,9            ; 分配词库大小的XMS空间                call    cs:xms_entry                or      ax,ax           ; 分配失败, 转                jz      short jnxms                mov     word ptr EMB_Dr_hand,dx                mov     word ptr EMB_Sr_hand,0                mov     word ptr EMB_Sr_offset,offset prg_end   ;cz_buf                mov     word ptr EMB_Sr_offset+2,cs                mov     ax,4200h                mov     bx,file_hand                xor     cx,cx                xor     dx,dx                int     21h             ; 文件指针指向0read_cont:                mov     ah,3fh                mov     bx,file_hand                mov     cx,20480d                mov     dx,offset prg_end       ;cz_buf                int     21h                or      ax,ax                jz      short read_end                test    ax,1                jz      short axeuu                inc     ax              ; 传送数据长度修正为偶数axeuu:                mov     word ptr EMB_count,ax                push    ax                mov     ah,0Bh                mov     si,offset EMB_count                call    cs:XMS_Entry                pop     ax                add     word ptr EMB_Dr_offset,ax                adc     word ptr EMB_Dr_offset+2,0                jmp     short read_contread_end:                mov     ax,EMB_Dr_hand                mov     EMB_Sr_hand,ax                mov     word ptr EMB_Dr_hand,0                mov     word ptr EMB_Dr_offset,offset cz_buf                mov     word ptr EMB_count,1024d*1dnoxms:                mov     ah,3eh                mov     bx,file_hand                int     21h                cmp     byte ptr ready,0                jz      short ngj65     ; 未安装过, 登记屏幕取词并驻留                mov     dx,offset int66                mov     ax,8366h                mov     bh,1            ; 自动搜索                mov     bl,yddj                or      bl,bl                jz      short notyd1                dec     bl                mov     bh,3            ; 预定notyd1:                int     16h             ; 登记 66H 中断                mov     ax,2A0Ah                int     16h             ; 取已登记的自由接口地址->ES:BX                mov     word ptr EMB_Dr_offset+2,es                mov     di,103h                xor     ah,ah                mov     al,ready                mov     cx,59d-12d                mul     cx                add     di,ax                mov     si,offset filename                repz    movsb           ; 搬移该输入法参数->已驻留的ACZY内部                int     20h             ; 程序结束ngj65:                jmp     umb_rest;get_cure_drv:;                mov     es,ds:[2Ch];                xor     di,di;                xor     al,al;                mov     cx,0FFFFh;                cld;ngcd:;                repnz   scasb;                inc     di;                cmp     byte ptr es:[di-1],0;                jnz     short ngcd;                mov     ax,es:[di+2];                cmp     ah,':';                jnz     short gcd_ret;                mov     word ptr filename[0],ax;                mov     word ptr no_find[27d],ax;gcd_ret:;                retn; ================================================================begin:;                call    get_cure_drv                mov     ax,95fdh                int     10h                cmp     ax,95fdh                jz      short no_ac                cmp     ax,0400h                jae     short vlokno_ac:                lea     dx,noacjerr_out:                jmp     err_outeout1:                mov     dx,offset nospk                jmp     short jerr_outvlok:                mov     ax,cs                cmp     ax,0A000h                jb      short not_lh                mov     dx,offset ct_lh                jmp     short jerr_outnot_lh:                test    bl,8                jz      short eout1                mov     ax,3516h                int     21h                mov     ax,word ptr es:[105h]                mov     ac_zhj,al                mov     altfun,ah               ; 输入法激活功能键                mov     ax,2A0Ah                int     16h                     ; 取已登记的自由接口地址                cmp     word ptr es:[bx-2],0FF00h                jz      short oknrs1            ; 未安装, 转                mov     ax,8366h                xor     bh,bh                int     16h                     ; 检查空间                cmp     ah,83h                jnz     short oknrs                mov     dx,offset no_space      ; 空间不足, 出错退出                jmp     short jerr_outoknrs:                inc     ah                mov     byte ptr ready,ah                cmp     ah,0Ah                jb      short o30h                xor     ah,aho30h:                add     ah,"0"          ;30h                mov     byte ptr num09,ahoknrs1:                call    get_psp                 ; 取命令行参数(编码文件名)                cmp     byte ptr yddj,0                jz      short nyddj                mov     ax,8366h                mov     bh,2                    ; 检查预定号                mov     bl,yddj                dec     bl                int     16h                jz      short nyddj1                mov     dx,offset cannotyd      ; 预定失败                jmp     jerr_outnyddj1:                mov     ah,yddj                mov     ready,ah                cmp     ah,0Ah                jb      short o30h1                xor     ah,aho30h1:                add     ah,"0"          ;30h                mov     byte ptr num09,ahnyddj:                mov     dx,offset filename                mov     ax,95fch                int     10h                mov     ax,3D00h                int     21h                push    cs                pop     ds                jnc     short okfile1                jmp     ldxnfokfile1:                mov     bx,ax                   ; 单字文件号->BX保存                mov     file_hand,bx                mov     cx,4                mov     dx,offset input_name                mov     ah,3fh                int     21h                cmp     byte ptr input_name,'4'         ; 4.0 版本标记                jz      short is40zyerr_zymb:                mov     ah,3eh                int     21h                mov     dx,offset need40                jmp     err_outis40zy:                mov     ax,word ptr input_name+1        ; 编码方式字节                cmp     al,'0'                jb      short err_zymb                cmp     al,'9'                ja      short nnumbm                sub     al,'0'                jmp     short okmbmnnumbm:                and     al,0DFh                cmp     al,'A'                jb      short err_zymb                cmp     al,'F'                ja      short err_zymb                sub     al,'A'-0Ahokmbm:                shl     al,4            ; 左半字节                cmp     ah,'0'                jb      short err_zymb                cmp     ah,'9'                ja      short nnumbm1                sub     ah,'0'                jmp     short okmbm1nnumbm1:                and     ah,0DFh                cmp     ah,'A'                jb      short err_zymb                cmp     ah,'F'                ja      short err_zymb                sub     ah,'A'-0Ahokmbm1:                or      al,ah                mov     in_if_09,al                mov     if_09,al                mov     al,byte ptr input_name+3   ; 最大码长                sub     al,30h                or      al,al                jnz     short n_ah10                mov     al,10d                  ; 最大码长范围 1-10n_ah10:                mov     in_zymi,al                mov     zymi,al                mov     cx,8                mov     dx,offset input_name    ; 文件输入法名(8字节)                mov     ax,3f00h                int     21h                push    cs                pop     es                cld                mov     si,offset input_name                mov     di,offset in_name                mov     cx,4                repz    movsw;                mov     si,offset input_name;                mov     di,offset copr_name;                mov     cx,4;                repz    movsw                mov     si,offset input_name                mov     di,offset have_name                mov     cx,4                repz    movsw                cmp     byte ptr ready,0                jz      short first                mov     ax,2A0Ah                int     16h             ; 取已登记的自由接口地址-> ES:BX                mov     di,103h+59d-12d                mov     cx,10dnx_vl:                push    di                push    cx                mov     si,offset filename                mov     cx,29d-12d                repz    cmpsb           ; 检查输入法文件是否已经安装过                pop     cx                pop     di                jz      short hv_vl     ; 是，提示返回                add     di,59d-12d                loop    nx_vlfirst:;                mov     dx,offset copr;                call    p9_call                jmp     load_mbp9_call:                mov     ah,9                int     21h                mov     dx,offset alt                cmp     byte ptr altfun,0                ja      short p9                mov     dx,offset ca                cmp     byte ptr ac_zhj,0Ch                jz      short p9                mov     dx,offset as                cmp     byte ptr ac_zhj,0Bh                jz      short p9                mov     dx,offset scp9:                mov     ah,9                int     21h                mov     dx,offset num09                mov     ah,9                int     21h                retnhv_vl:                cmp     cl,1                ja      short sbcl                xor     al,al                jmp     short oa30sbcl:                mov     al,11d                sub     al,cloa30:                or      al,30h                mov     byte ptr num09,al                mov     dx,offset have_been                call    p9_call                int     20h; ----------------------------------------------------------------------ldxnf:                lea     dx,no_find              ; 词汇文件不存在                jmp     err_outget_psp:                mov     si,80h                cmp     byte ptr [si],0                jz      short endfn                xor     bx,bxisiok:                inc     si                mov     al,byte ptr [si]                cmp     al,'/'                jnz     short nvdyd                inc     si                mov     al,byte ptr [si]                cmp     al,'0'                jb      short nvdyd                cmp     al,'9'                ja      short nvdyd                sub     al,"0"                or      al,al                jnz     short nal00A                mov     al,0Ahnal00a:                cmp     byte ptr ready,0                jz      short isiok             ; 首次执行,不能指定                mov     yddj,al                jmp     short isioknvdyd:                cmp     al,20h                jz      short isiok                cmp     al,9                jz      short isiok                cmp     al,'?'                jnz     short nxpsp                mov     dx,offset help                jmp     short err_outnxpsp:                lodsb                cmp     al,0Dh                jz      short pspend                cmp     al,'.'                jz      short pspend                cmp     al,'a'                jb      short naadf                cmp     al,'z'                ja      short naadf                and     al,0DFh         ; 转换成大写字母naadf:                mov     byte ptr fichg[bx],al                mov     byte ptr fichg1[bx],al                mov     byte ptr n40i[bx],al                inc     bx                cmp     bx,8            ; 取出最长８个字符文件名                jb      short nxpsppspend:                or      bx,bx                jz      short endfn                cmp     bx,8                jae     short endfn                mov     byte ptr fichg[bx],20h                mov     byte ptr fichg1[bx],20h                mov     byte ptr n40i[bx],20h                inc     bx                jmp     short pspendendfn:                retnerr_out:                mov     ah,9                int     21h                lea     dx,nf1                int     21h                int     20h;--------------------------------------------------------------ready           db      0ac_zhj          db      0altfun          db      0yddj            db      0       ; 预定登记号noac            db      7,'HOS not found!$'ct_lh           db      7,'错误: 不能使用 LOADHIGH 命令执行 IMD.COM!$'need40          db      7,'错误: 'n40i            db      'SP      .IMD 不是 IMD 格式! 请按《使用手册》说明修改.$'no_space        db      7,'错误: 输入法空间已满,无法再装入码表!$'cannotyd        db      7,'错误: 该功能键已被使用!$'nospk           db      7,'提示: 请先执行 INT16 汉字键盘模块!$'ca              db      'CTRL+ALT+$'as              db      'ALT+SHIFT+$'sc              db      'CTRL+SHIFT+$'alt             db      'ALT+F$'have_been       db      7,'提示: 万能输入法【'have_name       db      '　　　　】已安装过! 按 $';copr            db      '万能输入法【';copr_name       db      '　　　　】';                db      '安装成功! 按 $'num09           db      '1 使用',0dh,0ah,'$'no_find         db      '错误: 没有找到码表文件 ...\DRV\'fichg1          db      'SP      .IMD !',7,'$'help            db      0dh,0ah,'万能输入法安装',0dh,0ah,0ah                db      'IMD [/n] [码表]',0dh,0ah                db      '     /n  指定输入法功能键号(2,3...0)$'nf1             db      0dh,0ah,'$';--------------------------------------------------------------prg_end:                end     start